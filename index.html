<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

      <script>
        $(function() {
          setupLanguages(["dart","java","plaintext","javascript","python","ruby","c","csharp","scala"]);
        });
      </script>
  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="lang-selector">
              <a href="#" data-language-name="dart">Dart</a>
              <a href="#" data-language-name="java">Java</a>
              <a href="#" data-language-name="plaintext">Node.js</a>
              <a href="#" data-language-name="javascript">Javascript</a>
              <a href="#" data-language-name="python">Python</a>
              <a href="#" data-language-name="ruby">Ruby</a>
              <a href="#" data-language-name="c">C</a>
              <a href="#" data-language-name="csharp">C#</a>
              <a href="#" data-language-name="scala">Scala</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href="http://iot-dsa.org/">IOT-DSA Homepage</a></li>
            <li><a href="https://github.com/IOT-DSA/docs/wiki">IOT-DSA Wiki</a></li>
            <li><a href="http://iot-dsa.github.io/docs/sdks/dart/index.html">Dart API Reference</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="introduction">Introduction</h1>

<p>This guide will introduce you to the basics of communicating with a Broker using
the DSLink SDK. We&rsquo;ll learn how to send data to a Broker as well as how to
subscribe to data to get updates when other, or even our, data is changed.</p>

<aside class="notice">
While not covered in this documentation, it is important to know that an
additional component while creating a DSLink is a configuration file called
<code>dslink.json</code>. It is also suggested you also
<a href="https://github.com/IOT-DSA/docs/wiki/dslink.json">review the
documentation</a> from our Wiki on the content of a <code>dslink.json</code>
file.
</aside>

<h1 id="importing">Importing</h1>

<blockquote>
<p>Use the following to import the SDK.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// pubspec.yaml</span>
<span class="nl">dependencies:</span>
  <span class="nl">dslink:</span>
    <span class="nl">git:</span> <span class="nl">git:</span><span class="c1">//github.com/IOT-DSA/sdk-dslink-dart.git</span>


<span class="c1">// run.dart</span>
<span class="kn">import</span> <span class="s">'package:dslink/dslink.dart'</span><span class="o">;</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// For Gradle add this to your build.gradle dependencies.</span>
<span class="n">compile</span> <span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">iot</span><span class="o">-</span><span class="nl">dsa:dslink:</span><span class="mf">0.12</span><span class="o">.</span><span class="mi">0</span><span class="err">'</span>

<span class="c1">// For Apache Maven add this to your build.xml dependencies.</span>
<span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">iot</span><span class="o">-</span><span class="n">dsa</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">dslink</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">0.12</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre>
<pre class="highlight ruby"><code><span class="c1"># Add to your Gemfile</span>
<span class="n">gem</span> <span class="s1">'dslink'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'git://github.com/IOT_DSA/sdk-dslink-ruby.git'</span>

<span class="c1">#link.rb</span>
<span class="nb">require</span> <span class="s1">'dslink'</span>
</code></pre>
<pre class="highlight plaintext"><code>// package.json
"dependencies": {
  "dslink": "IOT-DSA/sdk-dslink-javascript#artifacts"
}

// index.js
var DS = require('dslink');
</code></pre>
<pre class="highlight javascript"><code><span class="c1">// index.html</span>
<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">"https://raw.githubusercontent.com/IOT-DSA/sdk-dslink-javascript/artifacts/dist/dslink.browser.min.js"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
<span class="c1">// DS is a globally accessed variable</span>
</code></pre>
<pre class="highlight python"><code><span class="c"># Add to your setup.py</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
        <span class="s">"dslink"</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c"># dslink.py</span>
<span class="kn">import</span> <span class="nn">dslink</span>
</code></pre>

<p>By using the Git repository, we ensure that we have the most up-to-date version
of the DSLink SDK. In the future, the SDK may be made available through common
package managers for each language.</p>

<h1 id="responder">Responder</h1>

<p>There are several types of DSLinks we can create. The first of which is called
a <em>Responder</em>. The Responder will provide data on demand. It will only send the
data when it&rsquo;s requested, eg it Responds.</p>

<aside class="notice">
The other types of Links are a <em>Requester</em> and a hybrid <em>Responder</em>
and <em>Requester</em>. We&rsquo;ll look at those types later.
</aside>

<h2 id="link">Link</h2>

<blockquote>
<p>Note that in some sdks we must pass the application startup arguments to the
link creation, other SDKs will automatically retrieve these arguments on their
own.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// run.dart</span>
<span class="n">main</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">var</span> <span class="n">link</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkProvider</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="s">'Example-'</span><span class="o">);</span>
  <span class="n">link</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
  <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight plaintext"><code>var link = new DS.LinkProvider(process.argv.slice(2), 'Example-');
link.connect();
</code></pre>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">LinkProvider</span><span class="p">(</span><span class="s1">'http://127.0.0.1:8080/conn'</span><span class="p">,</span> <span class="s1">'Example-'</span><span class="p">);</span>
<span class="nx">link</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// package ...</span>
<span class="c1">// import ...</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="kd">extends</span> <span class="n">DSLinkHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">Main</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="n">isResponder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">onResponderInitialized</span><span class="o">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Initialized"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">onResponderConnected</span><span class="o">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Connected"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">DSLinkFactory</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="k">new</span> <span class="n">Main</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="c"># dslink.py</span>
<span class="kn">import</span> <span class="nn">dslink</span>

<span class="k">class</span> <span class="nc">ExampleDSLink</span><span class="p">(</span><span class="n">dslink</span><span class="o">.</span><span class="n">DSLink</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Starting DSLink"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">ExampleDSLink</span><span class="p">(</span><span class="n">dslink</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="s">"example"</span><span class="p">,</span> <span class="n">responder</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</code></pre>

<p>In order to create any type of connection (Responder or Requester), we first
need to establish a link to the DSA Broker. In this example we will only
establish the bare minimum link. There are a number of configuration options
to further extend the capabilities. Refer to the documentation for the SDK
of the language of your choice.</p>

<p>The most basic Link will accept command line arguments passed the application
as well as a name for the Link. The ending hyphen is not optional, and will not
appear in the link. The name supplied here is what will show up under your
downstream connections (by default).</p>

<h2 id="nodes">Nodes</h2>

<p>Within the DSA Broker, all of our data is broken into a collection of nodes.
A node may be a link to a separate device, or it may be multiple links running
from a server. Each link may also have children nodes.</p>

<p>A node structure can be through of like a file directory tree on your computer
or a website&rsquo;s address/path. A Responder link will only have access to the nodes
it contains. As we will see later, a Requester can access any node that it has
permission to access.</p>

<h3 id="generate-a-random-number">Generate a Random Number</h3>

<blockquote>
<p>Generate a random number</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// At the top of the file add the import for the Math library.</span>
<span class="kn">import</span> <span class="s">'dart:math'</span><span class="o">;</span>
<span class="c1">// ...</span>

<span class="kd">var</span> <span class="n">numGen</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
<span class="kd">var</span> <span class="n">myNum</span> <span class="o">=</span> <span class="n">numGen</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
</code></pre>
<pre class="highlight plaintext"><code>var myNum = Math.round(Math.random() * 50);
</code></pre>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">myNum</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// Add this variable into your Main class.</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Random</span> <span class="n">RANDOM</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>

<span class="c1">// Generating a random number is as follows.</span>
<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
</code></pre>
<pre class="highlight python"><code><span class="c"># Import the random library at the top of the file</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">var</span> <span class="n">my_num</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</code></pre>

<p>Before we add the new, let&rsquo;s create a value that we can pass, and send updates
for. In this case we&rsquo;ll just generate a random number between 0 and 50.</p>

<h3 id="add-node">Add node</h3>

<blockquote>
<p>Add the node to our responder link.</p>
</blockquote>
<pre class="highlight dart"><code><span class="kd">var</span> <span class="n">myNode</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="na">addNode</span><span class="o">(</span><span class="s">'/MyNum'</span><span class="o">,</span>
<span class="c1">// Note the raw strings, the $ must be passed as well.</span>
  <span class="o">{</span> <span class="sx">r'$name'</span><span class="o">:</span> <span class="s">'My Number'</span><span class="o">,</span>
    <span class="sx">r'$type'</span> <span class="o">:</span> <span class="s">'int'</span><span class="o">,</span>
    <span class="s">'?value'</span> <span class="o">:</span> <span class="n">myNum</span><span class="o">});</span>
</code></pre>
<pre class="highlight plaintext"><code>var myNode = link.addNode('/MyNum', {
  '$name': 'My Number',
  '$type': 'int',
  '?value': myNum
});
</code></pre>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">myNode</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">addNode</span><span class="p">(</span><span class="s1">'/MyNum'</span><span class="p">,</span> <span class="p">{</span>
  <span class="s1">'$name'</span><span class="p">:</span> <span class="s1">'My Number'</span><span class="p">,</span>
  <span class="s1">'$type'</span><span class="p">:</span> <span class="s1">'int'</span><span class="p">,</span>
  <span class="s1">'?value'</span><span class="p">:</span> <span class="nx">myNum</span>
<span class="p">});</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// In your Main class</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponderInitialized</span><span class="p">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Node</span> <span class="n">superRoot</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="na">getNodeManager</span><span class="o">().</span><span class="na">getSuperRoot</span><span class="o">();</span>
    <span class="n">NodeBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">superRoot</span><span class="o">.</span><span class="na">createChild</span><span class="o">(</span><span class="s">"MyNum"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setDisplayName</span><span class="o">(</span><span class="s">"My Number"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setValueType</span><span class="o">(</span><span class="n">ValueType</span><span class="o">.</span><span class="na">NUMBER</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
    <span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="c"># In the DSLink class, implement get_default_nodes</span>
<span class="k">def</span> <span class="nf">get_default_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Get default super_root</span>
    <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root_node</span><span class="p">()</span>

    <span class="c"># Create MyNum Node</span>
    <span class="n">my_node</span> <span class="o">=</span> <span class="n">dslink</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">"MyNum"</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span> <span class="c"># Name the node, specify the parent</span>
    <span class="n">my_node</span><span class="o">.</span><span class="n">set_display_name</span><span class="p">(</span><span class="s">"My Number"</span><span class="p">)</span>
    <span class="n">my_node</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s">"int"</span><span class="p">)</span>
    <span class="n">my_node</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">my_num</span><span class="p">)</span>

    <span class="c"># Add my_node to the super_root</span>
    <span class="n">root</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">my_node</span><span class="p">)</span>

    <span class="c"># Return the super root</span>
    <span class="k">return</span> <span class="n">root</span>
</code></pre>

<p>Next we add our node to the Link. In this case we pass the node name, <code class="prettyprint">/MyNum</code>
and the configuration. The node name begins with a forward-slash (<code class="prettyprint">/</code>)
which indicate it is appended to the root of our DSLink.</p>

<p>In our node configuration, we provide a user friendly display name for our link,
this name will only appear in the the Link information, but does not affect the
name or path used when trying to access the value. Additionally we provide the
type of value that this node will provide, and the value itself, which is our
random number that we generated. For information on additional configuration
options for a node please refer to
<a href="https://github.com/IOT-DSA/docs/wiki/Configs">Node Configs</a></p>

<p>When we add the node, it will return a local copy of the node for us to work
with directly. Alternatively we can also perform many of the same operations
directly with link itself.</p>

<h2 id="updating-a-node">Updating a node</h2>
<pre class="highlight dart"><code><span class="k">new</span> <span class="n">Timer</span><span class="o">.</span><span class="na">periodic</span><span class="o">(</span><span class="kd">const</span> <span class="n">Duration</span><span class="o">(</span><span class="nl">seconds:</span> <span class="mi">5</span><span class="o">),</span> <span class="o">(</span><span class="n">_</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">myNum</span> <span class="o">=</span> <span class="n">numGen</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
    <span class="n">myNode</span><span class="o">.</span><span class="na">updateValue</span><span class="o">(</span><span class="n">myNum</span><span class="o">);</span>
<span class="o">});</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// In your Main class</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponderInitialized</span><span class="p">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// ...</span>

    <span class="n">Objects</span><span class="o">.</span><span class="na">getDaemonThreadPool</span><span class="o">().</span><span class="na">scheduleWithFixedDelay</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
            <span class="n">Value</span> <span class="n">val</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="n">node</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span> <span class="c"># Call again 1 second later</span>
</code></pre>

<p>A node is of limited value if it only provides the initial request and nothing
further. We want to provide updates to the value as things change. For our
demonstration, we will setup a timer which updates our number once ever five
seconds.</p>

<h2 id="checking-for-a-subscription">Checking for a subscription</h2>

<blockquote>
<p>Add this to the timer function.</p>
</blockquote>
<pre class="highlight dart"><code><span class="k">if</span><span class="o">(</span><span class="n">myNode</span><span class="o">.</span><span class="na">hasSubscriber</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// To be filled in soon</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// scheduleWithFixedDelay ...</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">link</span><span class="o">.</span><span class="na">getSubscriptionManager</span><span class="o">().</span><span class="na">hasValueSub</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">Value</span> <span class="n">val</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
        <span class="n">node</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="k">if</span> <span class="n">my_node</span><span class="o">.</span><span class="n">is_subscribed</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Node is subscribed"</span><span class="p">)</span>
</code></pre>

<p>In our simple example, we only want to update a value if there is someone
actively listening, or <em>subscribing</em>, to our node. We can check a node
specifically to see if it has a subscriber.</p>

<p>A value, however, should be set with at least an initial value, as once the value
is updated, it is possible that a subscription to the node may occur at any time.</p>

<aside class="notice">
In many situations it is preferable to have the latest value always ready rather
than a value which may be hours, or even days, old when the the node receives
its next subscription request.
</aside>

<h2 id="adding-an-action">Adding an action</h2>
<pre class="highlight dart"><code><span class="c1">// Our new constructor in which we pass both our default node for</span>
<span class="c1">// adding a value, and our profile, or action on that node.</span>
<span class="kd">var</span> <span class="n">nodeList</span> <span class="o">=</span> <span class="o">[];</span> <span class="c1">// Store all nodes we create to reference later.</span>

<span class="c1">// Following replaces previous link initialization.</span>
<span class="n">link</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkProvider</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="s">'Example-'</span><span class="o">,</span> <span class="nl">defaultNodes:</span> <span class="o">{</span>
  <span class="s">'AddNum'</span> <span class="o">:</span> <span class="o">{</span>
    <span class="sx">r'$name'</span> <span class="o">:</span> <span class="s">'Add number'</span><span class="o">,</span>
    <span class="sx">r'$is'</span> <span class="o">:</span> <span class="s">'addnum'</span><span class="o">,</span>
    <span class="sx">r'$invokable'</span> <span class="o">:</span> <span class="s">'write'</span><span class="o">,</span>
    <span class="sx">r'$params'</span> <span class="o">:</span> <span class="o">[{</span><span class="s">'name'</span> <span class="o">:</span> <span class="s">'value'</span><span class="o">,</span> <span class="s">'type'</span> <span class="o">:</span> <span class="s">'int'</span><span class="o">}]</span>
  <span class="o">}},</span> <span class="nl">profiles:</span> <span class="o">{</span>
    <span class="s">'addnum'</span> <span class="o">:</span> <span class="o">(</span><span class="kt">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">=&gt;</span>
        <span class="k">new</span> <span class="n">SimpleActionNode</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">,</span> <span class="kd">dynamic</span><span class="o">&gt;</span><span class="n">params</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">var</span> <span class="n">addVal</span> <span class="o">=</span> <span class="kt">int</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">params</span><span class="o">[</span><span class="s">'value'</span><span class="o">]);</span>
          <span class="kd">var</span> <span class="n">ndNum</span> <span class="o">=</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
          <span class="n">nodeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">link</span><span class="o">.</span><span class="na">addNode</span><span class="o">(</span><span class="s">'/MyNum</span><span class="si">$ndNum</span><span class="s">'</span><span class="o">,</span> <span class="o">{</span>
            <span class="sx">r'$name'</span> <span class="o">:</span> <span class="s">'My node #</span><span class="si">$ndNum</span><span class="s">'</span><span class="o">,</span>
            <span class="sx">r'$type'</span> <span class="o">:</span> <span class="s">'int'</span><span class="o">,</span>
            <span class="s">'?value'</span> <span class="o">:</span> <span class="n">addVal</span>
          <span class="o">}));</span>
          <span class="c1">// myNode.updateValue(myNum + addVal);</span>
        <span class="o">})</span>
<span class="o">});</span>
</code></pre>
<pre class="highlight dart"><code><span class="c1">// Add our initial node to our node list instead of a single variable</span>
<span class="n">nodeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">link</span><span class="o">.</span><span class="na">addNode</span><span class="o">(</span><span class="s">'/MyNum'</span><span class="o">,</span>
  <span class="o">{</span> <span class="sx">r'$name'</span><span class="o">:</span> <span class="s">'My Number'</span><span class="o">,</span>
    <span class="sx">r'$type'</span> <span class="o">:</span> <span class="s">'int'</span><span class="o">,</span>
    <span class="s">'?value'</span> <span class="o">:</span> <span class="n">myNum</span><span class="o">})</span>
<span class="o">);</span>

<span class="c1">// Update our timer to provide a new random number for each node not just</span>
<span class="c1">// the initial one.</span>
<span class="k">new</span> <span class="n">Timer</span><span class="o">.</span><span class="na">periodic</span><span class="o">(</span><span class="kd">const</span> <span class="n">Duration</span><span class="o">(</span><span class="nl">seconds:</span> <span class="mi">5</span><span class="o">),</span> <span class="o">(</span><span class="n">timer</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span><span class="o">(</span><span class="kd">var</span> <span class="n">myNode</span> <span class="k">in</span> <span class="n">nodeList</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Don't update if there's no value</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">myNode</span><span class="o">.</span><span class="na">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">continue</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">myNode</span><span class="o">.</span><span class="na">hasSubscriber</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">myNum</span> <span class="o">=</span> <span class="n">numGen</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
      <span class="n">myNode</span><span class="o">.</span><span class="na">updateValue</span><span class="o">(</span><span class="n">myNum</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// In your Main class</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponderInitialized</span><span class="p">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Node superRoot = ...</span>
    <span class="c1">// NodeBuilder builder = ...</span>
    <span class="c1">// ...</span>
    <span class="c1">// final Node node = ...</span>
    <span class="c1">// ...</span>

    <span class="n">builder</span> <span class="o">=</span> <span class="n">superRoot</span><span class="o">.</span><span class="na">createChild</span><span class="o">(</span><span class="s">"UpdateNum"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setSerializable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setDisplayName</span><span class="o">(</span><span class="s">"Update Number"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="k">new</span> <span class="n">Action</span><span class="o">(</span><span class="n">Permission</span><span class="o">.</span><span class="na">WRITE</span><span class="o">,</span>
                                  <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">ActionResult</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">handle</span><span class="o">(</span><span class="n">ActionResult</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
            <span class="n">Value</span> <span class="n">val</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="n">node</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}));</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">profile_manager</span><span class="o">.</span><span class="n">create_profile</span><span class="p">(</span><span class="s">"addnum"</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">profile_manager</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="s">"addnum"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addnum</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_default_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root_node</span><span class="p">()</span>

    <span class="n">my_num</span> <span class="o">=</span> <span class="n">dslink</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">"MyNum"</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
    <span class="n">my_num</span><span class="o">.</span><span class="n">set_display_name</span><span class="p">(</span><span class="s">"My Number"</span><span class="p">)</span>
    <span class="n">my_num</span><span class="o">.</span><span class="n">set_type</span><span class="p">(</span><span class="s">"int"</span><span class="p">)</span>
    <span class="n">my_num</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">add_num</span> <span class="o">=</span> <span class="n">dslink</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">"AddNum"</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
    <span class="n">add_num</span><span class="o">.</span><span class="n">set_display_name</span><span class="p">(</span><span class="s">"Add number"</span><span class="p">)</span>
    <span class="n">add_num</span><span class="o">.</span><span class="n">set_profile</span><span class="p">(</span><span class="s">"addnum"</span><span class="p">)</span>
    <span class="n">add_num</span><span class="o">.</span><span class="n">set_invokable</span><span class="p">(</span><span class="s">"write"</span><span class="p">)</span>
    <span class="n">add_num</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">([</span>
        <span class="p">{</span>
            <span class="s">"name"</span><span class="p">:</span> <span class="s">"Number"</span><span class="p">,</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"int"</span>
        <span class="p">}</span>
    <span class="p">])</span>

    <span class="n">root</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">my_num</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">add_num</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">root</span>

<span class="k">def</span> <span class="nf">addnum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">"Number"</span><span class="p">])</span> <span class="c"># Parse number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">super_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/MyNum"</span><span class="p">)</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="c"># Set value</span>
    <span class="k">return</span> <span class="p">[[]]</span> <span class="c"># Return empty columns</span>
</code></pre>

<p>Sometimes we may wish to allow our Link to respond to an action. That is, we
may want to allow a user to send a command to our link so it can perform
some type of function. That function may be to execute a command on the system,
poll or retrieve additional data, or any other functionality we may want to
include.</p>

<p>In our sample, we are going to add a command to allow our number generator
to provide multiple values, and initialize it with a default value.</p>

<p>To setup our actions is a two-step process. The first of which is to add a node
to our Link. The second is to add a <code class="prettyprint">profile</code> to the link which will correspond
to the node. A profile can be considered a method which is executed when a node
of that type receives an <code class="prettyprint">invoke</code> call. The return of this method is a node
which executes our desired tasks and returns, if applicable, any data. This
process will become clear soon.</p>

<aside class="warning">
Currently, the only way to accurately provide a profile is by passing it as part
of the constructor for the LinkProvider.
</aside>

<aside class="notice">
The SDK&rsquo;s contain some helper classes which make the creation of a node easier.
</aside>

<h2 id="saving-a-link-39-s-state">Saving a link&rsquo;s state</h2>

<blockquote>
<p>Initialize the link to load any existing saved data.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// after the link = new LinkProvider(..) and before link.connect();</span>
<span class="n">link</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// All the nodes are automatically reinitialized again on startup.</span>
</code></pre>
<pre class="highlight python"><code><span class="c"># The Python SDK initializes itself when implementing the class.</span>
</code></pre>

<blockquote>
<p>Call save on the link.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// Add outside of the for loop inside the Timer call.</span>
<span class="n">link</span><span class="o">.</span><span class="na">save</span><span class="o">();</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// All the nodes are automatically saved.</span>
</code></pre>
<pre class="highlight python"><code><span class="c"># The Python SDK saves state automatically.</span>
</code></pre>

<p>We can now add as many values to our link as we like. And every 5 seconds, a
new number is generated for each of these nodes. However if we stop our link,
and restart it, we&rsquo;ll find that all of the additional nodes we created no longer
exist. Nor does it initialize with the previous values which were being stored.</p>

<p>When a link is saved, it will create a <code class="prettyprint">node.json</code> which will store the state
of our link and nodes at that time. In order to properly use the data from
the save file, we also need to ensure we initialize the link prior to
connecting.</p>

<aside class="notice">
Some SDK&rsquo;s will automatically initialize the node on connection, however it is
best practice to explicitly initialize the link yourself.
</aside>

<p>Now if we restart our link, the values we added are already included when it
reconnects to our broker</p>

<h2 id="getting-child-nodes">Getting child nodes</h2>

<blockquote>
<p>Get the root node of our Responder Link.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// At the top of our Timer callback.</span>
<span class="kd">var</span> <span class="n">rootNode</span> <span class="o">=</span> <span class="o">~</span><span class="n">link</span><span class="o">;</span> <span class="c1">// Shortcut for link.getNode('/');</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// Retrieves the super root of the responder.</span>
<span class="n">Node</span> <span class="n">superRoot</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="na">getNodeManager</span><span class="o">().</span><span class="na">getSuperRoot</span><span class="o">();</span>
</code></pre>
<pre class="highlight python"><code><span class="n">root_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">super_root</span>
</code></pre>

<blockquote>
<p>Update for loop to iterate over the children of the root node.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">/// rootNode.children returns a Map&lt;String, Node&gt; where String</span>
<span class="c1">/// is the node identifier and Node is the [Node] object itself.</span>
<span class="k">for</span><span class="o">(</span><span class="kd">var</span> <span class="n">nodeName</span> <span class="k">in</span> <span class="n">rootNode</span><span class="o">.</span><span class="na">children</span><span class="o">.</span><span class="na">keys</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">var</span> <span class="n">myNode</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">[</span><span class="n">nodeName</span><span class="o">];</span>
  <span class="c1">// ... Existing checking for subscriber and updating value</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight java"><code><span class="c1">// Iterate all the children of the super root.</span>
<span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">child</span> <span class="o">:</span> <span class="n">superRoot</span><span class="o">.</span><span class="na">getChildren</span><span class="o">().</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="k">for</span> <span class="n">child_name</span> <span class="ow">in</span> <span class="n">root_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">root_node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span>
</code></pre>

<p>After we&rsquo;ve restarted the link, you may notice a slight problem. Any values that
were added to the node are not being updated. This is because we explicitly
tracked them in our own list rather than querying our link for its child nodes.</p>

<p>First we query our link for the root node (top-most node). Once we have that
we can iterate over the children nodes to update each of those values.</p>

<h2 id="nesting-nodes">Nesting Nodes</h2>

<blockquote>
<p>Update the default nodes</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">/// Change the default nodes from our constructor.</span>
<span class="c1">/// The rest of the constructor stays the same.</span>
<span class="nl">defaultNodes:</span> <span class="o">{</span>
  <span class="s">'CustomNumbers'</span> <span class="o">:</span> <span class="o">{</span>
    <span class="sx">r'$name'</span> <span class="o">:</span> <span class="s">'Custom Numbers'</span><span class="o">,</span>
    <span class="s">'AddNum'</span> <span class="o">:</span> <span class="o">{</span>
      <span class="c1">// ... Previous information still here.</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">},</span>
</code></pre>
<pre class="highlight java"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponderInitialized</span><span class="p">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Node</span> <span class="n">superRoot</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="na">getNodeManager</span><span class="o">().</span><span class="na">getSuperRoot</span><span class="o">();</span>
    <span class="n">NodeBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">superRoot</span><span class="o">.</span><span class="na">createChild</span><span class="o">(</span><span class="s">"Numbers"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setSerializable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Node</span> <span class="n">numbers</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">builder</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">createChild</span><span class="o">(</span><span class="s">"MyNum"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setDisplayName</span><span class="o">(</span><span class="s">"My Number"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setValueType</span><span class="o">(</span><span class="n">ValueType</span><span class="o">.</span><span class="na">NUMBER</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
    <span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="n">Objects</span><span class="o">.</span><span class="na">getDaemonThreadPool</span><span class="o">().</span><span class="na">scheduleWithFixedDelay</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">link</span><span class="o">.</span><span class="na">getSubscriptionManager</span><span class="o">().</span><span class="na">hasValueSub</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                <span class="n">Value</span> <span class="n">val</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
                <span class="n">node</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight python"><code><span class="n">my_num</span> <span class="o">=</span> <span class="n">dslink</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">"MyNum"</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

<span class="n">add_num</span> <span class="o">=</span> <span class="n">dslink</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s">"AddNum"</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

<span class="n">my_num</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">add_num</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">my_num</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Update location our action adds to.</p>
</blockquote>
<pre class="highlight dart"><code><span class="c1">// Within our addnum profile update where we add the</span>
<span class="c1">// new node when the action runs.</span>
<span class="n">link</span><span class="o">.</span><span class="na">addNode</span><span class="o">(</span><span class="s">'/CustomNumbers/MyNum</span><span class="si">$ndNum</span><span class="s">'</span><span class="o">,</span> <span class="o">{</span>
<span class="c1">// ... rest of the code is the same.</span>
</code></pre>
<pre class="highlight java"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponderInitialized</span><span class="p">(</span><span class="kd">final</span> <span class="n">DSLink</span> <span class="n">link</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// final Node numbers = ...</span>
    <span class="c1">// final Node node = ...</span>
    <span class="c1">// ...</span>

    <span class="n">builder</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">createChild</span><span class="o">(</span><span class="s">"UpdateNum"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setSerializable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setDisplayName</span><span class="o">(</span><span class="s">"Update Number"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="k">new</span> <span class="n">Action</span><span class="o">(</span><span class="n">Permission</span><span class="o">.</span><span class="na">WRITE</span><span class="o">,</span>
                                  <span class="k">new</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="n">ActionResult</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">handle</span><span class="o">(</span><span class="n">ActionResult</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
            <span class="n">Value</span> <span class="n">val</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Value</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="n">node</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}));</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Initialized"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>

<p>As the number of nodes grows, having a series of nodes all at the top level
can become a nightmare. Often it is preferable to create a hierarchy for values.
Lets change the location of our custom numbers to be under their own node and
move the action to that node.</p>

<p>First create a new mapping of the default node hierarchy. In this case we&rsquo;re
actually wrapping our existing <code class="prettyprint">AddNum</code> node with the new node <code class="prettyprint">CustomNumbers</code>.</p>

<p>Next we just need to ensure that when the action is triggered to add a new
custom value (eg: <code class="prettyprint">My Node #1</code>), that it gets added under the <code class="prettyprint">Customer Numbers</code>
section as opposed to the top level node.</p>

<aside class="notice">
It&rsquo;s left as an exercise to the reader to implement the required updates
to generate random values in the new location, as well as the original
MyNum value.
</aside>

<p>The <code class="prettyprint">&#39;$name&#39;</code> field of our <code class="prettyprint">CustomNumbers</code> node is entirely optional, but
it provides an easier way of reading the node within a broker. However this
value does not need to match the name of the node in any way and does not
impact its configuration at all. It is only meta data. Full documentation on
the meta data and configuration for a node is
<a href="https://github.com/IOT-DSA/docs/wiki/Configs#core-configs">available from our Wiki</a>.</p>

<aside class="warning">
Node paths should be alphanumeric only with spaces or underscores. Node paths
cannot include a number of special characters.
</aside>

          <h1 id="requesters">Requesters</h1>

<p>While a <code class="prettyprint">Responder</code> provides information on-demand, a <code class="prettyprint">Requester</code> will
provide data when it needs to. This could be by Requesting information
that it needs, or by pushing data to an existing value. We&rsquo;ll look at how
to view currently available nodes and <code class="prettyprint">subscribe</code> to a specific one.</p>

<aside class="notice">
It is important to note, that while a requester may subscribe to a
specific node, the Requester is actually subscribing to the Broker for
that data, not to the node directly. The Broker will receive updates and
pass them along to as many Requesters. Any given responder will only have
the connection to the Broker not multiple Requesters.
</aside>

<h2 id="link">Link</h2>

<blockquote>
<p>Initialize a Requester only link</p>
</blockquote>
<pre class="highlight dart"><code><span class="kd">var</span> <span class="n">link</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkProvider</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="s">'RequesterExample-'</span><span class="o">,</span>
               <span class="nl">isRequester:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">isResponder:</span> <span class="kc">false</span><span class="o">);</span>
<span class="n">await</span> <span class="n">link</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
<span class="kd">var</span> <span class="n">requester</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="na">requester</span><span class="o">;</span>
</code></pre>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">LinkProvider</span><span class="p">(</span><span class="s1">'http://127.0.0.1:8080/conn'</span><span class="p">,</span> <span class="s1">'RequesterExample-'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">isRequester</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">isResponder</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">});</span>

<span class="nx">link</span><span class="p">.</span><span class="nx">connect</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">link</span><span class="p">.</span><span class="nx">onRequesterReady</span><span class="p">;</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">requester</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// work with requester here  </span>
<span class="p">});</span>
</code></pre>
<pre class="highlight plaintext"><code>var link = new DS.LinkProvider(args, 'RequesterExample-', {
  isRequester: true,
  isResponder: false
});

link.connect().then(function() {
  return link.onRequesterReady;
}).then(function(requester) {
   // work with requester here  
});
</code></pre>

<p>Each link can be a Responder or a Requester (or both). At this time we&rsquo;re
only interested in creating a requester so we initialize our link specifically
for the requester.</p>

<p>After the link connects, we can the access the requester directly in order to
query the broker for nodes.</p>

<h2 id="query-nodes">Query Nodes</h2>

<blockquote>
<p>Recursively poll nodes and children.</p>
</blockquote>
<pre class="highlight dart"><code><span class="n">iterateChildren</span><span class="o">(</span><span class="n">RemoteNode</span> <span class="n">nd</span><span class="o">)</span> <span class="n">async</span> <span class="o">{</span>
  <span class="n">print</span><span class="o">(</span><span class="s">'Node: </span><span class="si">${nd.remotePath}</span><span class="s">'</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">nd</span><span class="o">.</span><span class="na">children</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kd">var</span> <span class="n">nodeName</span> <span class="k">in</span> <span class="n">nd</span><span class="o">.</span><span class="na">children</span><span class="o">.</span><span class="na">keys</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">var</span> <span class="n">path</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="na">remotePath</span> <span class="o">+</span> <span class="s">'/</span><span class="si">$nodeName</span><span class="s">'</span><span class="o">;</span>
      <span class="n">iterateChildren</span><span class="o">(</span><span class="n">await</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRemoteNode</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// Query initial node and pass it to our recursive function.</span>
<span class="kd">var</span> <span class="n">exampleNode</span> <span class="o">=</span>
      <span class="n">await</span> <span class="n">requester</span><span class="o">.</span><span class="na">getRemoteNode</span><span class="o">(</span><span class="s">'/downstream/Example'</span><span class="o">);</span>
<span class="n">iterateChildren</span><span class="o">(</span><span class="n">exampleNode</span><span class="o">);</span>
</code></pre>
<pre class="highlight plaintext"><code>function iterateChildren(nd) {
  console.log('Node: ' + nd.remotePath);
  var keys = Object.keys(nd.children);
  if (keys.length &gt; 0) {
    keys.forEach(function(nodeName) {
      var path = nd.remotePath + '/' + nodeName;
      requester.getRemoteNode(path).then(function(node) {
        iterateChildren(node);
      });
    });
  }
}

// Query initial node and pass it to our recursive function.
requester.getRemoteNode('/downstream/Example').then(function(exampleNode) {
  iterateChildren(exampleNode);  
});
</code></pre>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">iterateChildren</span><span class="p">(</span><span class="nx">nd</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Node: '</span> <span class="o">+</span> <span class="nx">nd</span><span class="p">.</span><span class="nx">remotePath</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">nd</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">nd</span><span class="p">.</span><span class="nx">remotePath</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="nx">nodeName</span><span class="p">;</span>
      <span class="nx">requester</span><span class="p">.</span><span class="nx">getRemoteNode</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">iterateChildren</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Query initial node and pass it to our recursive function.</span>
<span class="nx">requester</span><span class="p">.</span><span class="nx">getRemoteNode</span><span class="p">(</span><span class="s1">'/downstream/Example'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">exampleNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">iterateChildren</span><span class="p">(</span><span class="nx">exampleNode</span><span class="p">);</span>  
<span class="p">});</span>
</code></pre>

<p>With the requester, we can now query a node from the broker and get a listing
of the nodes and recursively poll their children. For this sample we are going
to query the broker for the nodes of the Responder link we created previously.</p>

<aside class="warning">
Ensure that your Responder link is connected to your broker before trying
out this code.
</aside>

<p>You&rsquo;ll notice that we query for each child node, rather than accessing it from
the parent node. This is due to the fact that when a remote node is returned,
the content it contains is limited to prevent large amounts of data from being
transferred when only a small subset may be required. Part of the restricted
content is the full child node, and its own children. Also included in the
restricted content is the value of a node, as depending on the node, the value
may be anything from a single integer to a fully populated table, to even a
file on the system.</p>

<h2 id="list-nodes">List Nodes</h2>
<pre class="highlight dart"><code><span class="c1">// Replace print('Node: ${nd.remotePath}'); in</span>
<span class="c1">// iterateChildren with:</span>
<span class="n">requester</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">nd</span><span class="o">.</span><span class="na">remotePath</span><span class="o">).</span><span class="na">listen</span><span class="o">(</span><span class="n">listUpdates</span><span class="o">);</span>

<span class="c1">// A new function outside of main</span>
<span class="kt">void</span> <span class="nf">listUpdates</span><span class="p">(</span><span class="n">RequesterListUpdate</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">print</span><span class="o">(</span><span class="s">'Node - </span><span class="si">${update.node.name}</span><span class="s">'</span><span class="o">);</span>
  <span class="n">print</span><span class="o">(</span><span class="s">'</span><span class="se">\t</span><span class="s">Changes: </span><span class="si">${update.changes}</span><span class="s">'</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight plaintext"><code>// Replace console.log('Node: ' + nd.remotePath) in
// iterateChildren with:
requester.list(nd.remotePath).on("data", listUpdates);

// a new function that is globally defined
function listUpdates(update) {
  console.log('Node - ' + update.node.name);
  console.log('\tChanges: ' + update.changes);
}
</code></pre>
<pre class="highlight javascript"><code><span class="c1">// Replace console.log('Node: ' + nd.remotePath) in</span>
<span class="c1">// iterateChildren with:</span>
<span class="nx">requester</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="nx">nd</span><span class="p">.</span><span class="nx">remotePath</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="nx">listUpdates</span><span class="p">);</span>

<span class="c1">// a new function that is globally defined</span>
<span class="kd">function</span> <span class="nx">listUpdates</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Node - '</span> <span class="o">+</span> <span class="nx">update</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'\tChanges: '</span> <span class="o">+</span> <span class="nx">update</span><span class="p">.</span><span class="nx">changes</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>Iterating over children is great when we initialize our connection, however
it won&rsquo;t report any changes to those nodes, such as if a new child node is
added, removed or modified. The list method on the Requester takes the full
path of the node, and will call a method every time a change occurs to the
node which is passed to it.</p>

<p>The <code class="prettyprint">list</code> method will provide an update object which contains the node which
was changed, and the configuration, attributes or children which were changed.
It will only provide the updates of the specific node, and not any children
of that node, so we need to ensure we call it on each node we want to keep
updated on.</p>

<p>With the Responder and Requester links running, try adding a new node to our
custom numbers and observe the output from the Requester link we&rsquo;ve created.</p>

<h2 id="subscribing-to-nodes">Subscribing to Nodes</h2>
<pre class="highlight dart"><code><span class="c1">// Replace requester.list(nd.remotePath).listen(listUpdates);</span>
<span class="c1">// in iterate children with:</span>
<span class="k">if</span> <span class="o">(</span><span class="n">nd</span><span class="o">.</span><span class="na">getConfig</span><span class="o">(</span><span class="sx">r'$type'</span><span class="o">)</span> <span class="o">==</span> <span class="s">'int'</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">requester</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">nd</span><span class="o">.</span><span class="na">remotePath</span><span class="o">,</span>
    <span class="o">(</span><span class="n">ValueUpdate</span> <span class="n">update</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">subscribeUpdates</span><span class="o">(</span><span class="n">update</span><span class="o">,</span> <span class="n">nd</span><span class="o">.</span><span class="na">name</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// A new function outside of main.</span>
<span class="kt">void</span> <span class="nf">subscribeUpdates</span><span class="p">(</span><span class="n">ValueUpdate</span> <span class="n">update</span><span class="o">,</span> <span class="kt">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">print</span><span class="o">(</span><span class="s">'Name: </span><span class="si">$name</span><span class="s"> ValueUpdate: </span><span class="si">${update.value}</span><span class="s">'</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
<pre class="highlight plaintext"><code>// Replace requester.list(nd.remotePath).on("data", listUpdates)
// in iterateChildren with:
if (nd.getConfig('$type') === 'int') {
  requester.subscribe(nd.remotePath,
    function(update) { subscribeUpdates(update, nd.name); });
}

// a new function that is globally defined
function subscribeUpdates(update, name) {
  console.log('Name: ' + name + ' ValueUpdate: ' + update.value);
}
</code></pre>
<pre class="highlight javascript"><code><span class="c1">// Replace requester.list(nd.remotePath).on("data", listUpdates)</span>
<span class="c1">// in iterateChildren with:</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">nd</span><span class="p">.</span><span class="nx">getConfig</span><span class="p">(</span><span class="s1">'$type'</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'int'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">requester</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">nd</span><span class="p">.</span><span class="nx">remotePath</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span> <span class="nx">subscribeUpdates</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="nx">nd</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// a new function that is globally defined</span>
<span class="kd">function</span> <span class="nx">subscribeUpdates</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Name: '</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">' ValueUpdate: '</span> <span class="o">+</span> <span class="nx">update</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>

<p>When listing nodes, we see the changes in a node&rsquo;s configuration including
any new children. However we do not receive the actual values when they&rsquo;re
updated by the Responder. To get the change of a values, and only the change
in that value, we need to <code class="prettyprint">subscribe</code> to that node.</p>

<p>Using <code class="prettyprint">subscribe</code> will activate the <code class="prettyprint">hasSubscriber</code> flag on a node. It will
also receive any updates to that node. In the sample we also verify that the
node we&rsquo;re looking has a <code class="prettyprint">$type</code> value of <code class="prettyprint">int</code>.</p>

<aside class="notice">
You can only subscribe to a single value. You <strong>cannot</strong> subscribe
to a parent node and receive all child updates.
</aside>

          <div id="disqus_thread"></div>

<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = 'http://docs.iot-dsa.org'; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'apidocs_main'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//dsaapidocs.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="dart">Dart</a>
                <a href="#" data-language-name="java">Java</a>
                <a href="#" data-language-name="plaintext">Node.js</a>
                <a href="#" data-language-name="javascript">Javascript</a>
                <a href="#" data-language-name="python">Python</a>
                <a href="#" data-language-name="ruby">Ruby</a>
                <a href="#" data-language-name="c">C</a>
                <a href="#" data-language-name="csharp">C#</a>
                <a href="#" data-language-name="scala">Scala</a>
          </div>
      </div>
    </div>
  </body>
</html>
